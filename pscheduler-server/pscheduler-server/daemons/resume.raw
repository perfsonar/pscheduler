#!/usr/bin/env python3
#
# Resume pScheduler testing
#

import argparse
import pscheduler
import sys

#
# Gargle the arguments
#

arg_parser = argparse.ArgumentParser(
    usage="%(prog)s",
    epilog=
    """
Examples:

  resume
      Resume running of tasks
""",
    formatter_class=argparse.RawTextHelpFormatter
)

# Program options

arg_parser.add_argument("-d", "--dsn",
                      help="Database connection string, prefix with @ to read from file",
                      action="store", type=str, dest="dsn",
                      default="@__DSNFILE__")

args = arg_parser.parse_args()

dsn = args.dsn

# TODO: Bulletproof the SQL queries
try:
    db = pscheduler.pg_connection(dsn)
    cursor = db.cursor()
except Exception as ex:
    pscheduler.fail("Unable to connect to the database: %s" % str(ex))


#
# Force resumption
#

try:
    cursor.execute("SELECT control_resume()")
except Exception as ex:
    pscheduler.fail("Failed to resume: %s" % str(ex))
