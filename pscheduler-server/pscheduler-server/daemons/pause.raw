#!/usr/bin/env python3
#
# Pause pScheduler or query its paused state
#

import argparse
import pscheduler
import sys

#
# Gargle the arguments
#

arg_parser = argparse.ArgumentParser(
    usage="%(prog)s [ --query | duration ]",
    epilog=
"""
Examples:

  pause
      Pause indefinitely

  pause PT2H
      Pause for two hours

  pause --query
      Determine if the system is paused, exiting 0 if it is or 1 if
      not, displaying a message if the standard output is a TTY.
""",
    formatter_class=argparse.RawTextHelpFormatter
)

# Program options

arg_parser.add_argument("-d", "--dsn",
                      help="Database connection string, prefix with @ to read from file",
                      action="store", type=str, dest="dsn",
                      default="@__DSNFILE__")
arg_parser.add_argument("-q", "--query",
                      help="Query if runs are paused",
                      action="store_true", dest="query")
arg_parser.add_argument("-v", "--verbose",
                      help="Print messages even if stdout is not a tty",
                      action="store_true", dest="verbose")

arg_parser.add_argument("duration",
                        help="Length of time the system should be paused (ISO8601)",
                        nargs="?")

args = arg_parser.parse_args()

if args.query and args.duration:
    arg_parser.print_usage()
    pscheduler.fail()

if args.duration:
    try:
        duration = pscheduler.iso8601_as_timedelta(args.duration)
    except ValueError as ex:
        pscheduler.fail("%s: %s" % (args.duration, str(ex)))
else:
    duration = None


dsn = args.dsn

verbose = args.verbose or sys.stdout.isatty()


# TODO: Bulletproof the SQL queries
try:
    db = pscheduler.pg_connection(dsn)
    cursor = db.cursor()
except Exception as ex:
    pscheduler.fail("Unable to connect to the database: %s" % str(ex))


#
# Query the current state
#

if args.query:
    cursor.execute("""
        SELECT
            control_is_paused(),
            pause_runs_until,
            date_trunc('second', pause_runs_until - now()),
            pause_runs_until = tstz_infinity()
        FROM control
    """)
    if cursor.rowcount != 1:
        pscheduler.fail("Got back more data than expected.")
    (is_paused, until, left, infinite) = cursor.fetchone()

    if is_paused:
        if verbose:
            if infinite:
                print("pScheduler is paused indefinitely.")
            else:
                print(("pScheduler is paused until %s (%s from now)." \
                    % ( pscheduler.datetime_as_iso8601(until),
                        pscheduler.timedelta_as_iso8601(left) )))
        pscheduler.succeed()
    else:
        if verbose:
            print("pScheduler is running.")
        pscheduler.fail()

    assert(False)  # Shouldn't get here.


#
# Force a pause
#

if verbose and duration is None:
        print("Pausing indefinitely.")

try:
    cursor.execute("SELECT control_pause(%s)", [duration])
except Exception as ex:
    pscheduler.fail("Failed to pause: %s" % str(ex))
